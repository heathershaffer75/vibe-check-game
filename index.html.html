<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attachment Arcade — Scenarios & Responses</title>
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --ink: #0f172a;
      --muted: #6b7280;
      --accent: #4338ca;
      --edge: #e5e7eb;
      --good: #0f766e;      /* secure */
      --warn: #b45309;      /* disorganized */
      --anx:  #b91c1c;      /* anxious */
      --avo:  #1f2937;      /* avoidant */
      --ring: rgba(67,56,202,0.15);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink);
      background: linear-gradient(180deg, #fafafa 0%, #f1f5f9 100%);
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    .brand {
      display: flex; align-items: center; gap: 12px;
    }
    .logo {
      width: 44px; height: 44px; border-radius: 12px;
      background: conic-gradient(from 140deg at 50% 50%, #4338ca, #06b6d4, #10b981, #f59e0b, #ef4444, #4338ca);
      box-shadow: 0 6px 16px rgba(67,56,202,0.25);
      position: relative;
    }
    .logo::after{
      content:""; position:absolute; inset:6px; border-radius:10px; background: #fff9; backdrop-filter: blur(2px);
    }
    h1 { font-size: clamp(20px, 3vw, 28px); margin: 0; }
    .sub { color: var(--muted); font-size: 14px; margin-top: 2px; }

    .controls {
      display: grid; grid-template-columns: 1fr; gap: 12px;
      margin-bottom: 16px;
    }

    @media (min-width: 900px) {
      .controls { grid-template-columns: 1fr auto auto; align-items: end; }
    }

    .card { background: var(--card); border: 1px solid var(--edge); border-radius: 16px; box-shadow: 0 10px 22px rgba(15,23,42,0.06); }
    .pad { padding: 16px; }

    .btn {
      appearance: none; border: 1px solid var(--edge); background: #fff; color: var(--ink);
      border-radius: 12px; padding: 10px 14px; font-weight: 600; cursor: pointer;
      transition: transform .05s ease, box-shadow .2s ease, border-color .2s ease;
      box-shadow: 0 2px 0 rgba(15,23,42,0.08);
    }
    .btn:hover { box-shadow: 0 6px 16px rgba(15,23,42,0.10); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: var(--accent); color: #fff; border-color: transparent; }
    .btn.ghost { background: transparent; }

    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; }

    .timer {
      display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center;
    }
    .timer .face {
      width: 64px; height: 64px; border-radius: 50%; position: relative; display: grid; place-items: center;
      background: radial-gradient(circle at 30% 30%, #fff, #f8fafc);
      box-shadow: inset 0 0 0 6px var(--ring), 0 6px 16px rgba(15,23,42,0.10);
      font-weight: 800;
    }
    .timer .face[data-running="true"] { outline: 3px solid var(--accent); }

    .grid {
      display: grid; grid-template-columns: 1fr; gap: 16px;
    }
    @media (min-width: 1000px) {
      .grid { grid-template-columns: 2fr 1fr; }
    }

    .scenario {
      display: grid; grid-template-rows: auto auto 1fr; gap: 12px;
      min-height: 360px;
    }
    .prompt { font-size: clamp(18px, 2.4vw, 24px); line-height: 1.35; }
    .pill {
      display: inline-flex; align-items: center; gap: 8px; font-size: 12px; padding: 6px 10px;
      border-radius: 99px; background: #eef2ff; color: #1e1b4b; border: 1px solid #c7d2fe;
    }

    .options { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 800px) { .options { grid-template-columns: 1fr 1fr; } }

    .option {
      text-align: left; padding: 14px; border-radius: 12px; border: 1px solid var(--edge); background: #fff;
      cursor: pointer; transition: transform .05s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
      box-shadow: 0 4px 10px rgba(15,23,42,0.06);
    }
    .option:hover { background: #f8fafc; box-shadow: 0 8px 16px rgba(15,23,42,0.08); }
    .option strong { display:block; font-size: 14px; margin-bottom: 6px; color: var(--muted); }

    .reveal { border-top: 1px dashed var(--edge); padding-top: 12px; display: none; }
    .reveal.visible { display: block; animation: pop .2s ease; }
    @keyframes pop { from { transform: scale(.98); opacity: .6; } }

    .tag { display:inline-block; font-weight:700; font-size: 12px; padding: 4px 8px; border-radius: 999px; color:#fff; }
    .tag.secure{ background: var(--good); }
    .tag.anx{ background: var(--anx); }
    .tag.avo{ background: var(--avo); }
    .tag.dis{ background: var(--warn); }

    .side {
      display: grid; gap: 12px; align-content: start;
    }
    .list { display:grid; gap: 8px; max-height: 280px; overflow:auto; }

    .note { border:1px dashed var(--edge); border-radius:12px; padding:10px; background:#fff; font-size:14px; }

    .muted { color: var(--muted); font-size: 13px; }

    .kicker { font-size: 12px; letter-spacing:.1em; text-transform:uppercase; color: var(--muted); }

    .footer { margin-top: 20px; text-align: center; color: var(--muted); font-size: 12px; }

    /* Presenter mode */
    .present body {}
    .present .side { display: none; }
    .present .controls { display: none; }
    .present .wrap { max-width: 1000px; }
    .present .prompt { font-size: clamp(22px, 3.5vw, 36px); }
    .present .option { font-size: clamp(16px, 2.2vw, 22px); }
    .present .reveal p { font-size: clamp(16px, 2vw, 20px); }

    /* Modal */
    .modal { position: fixed; inset: 0; display: none; place-items: center; background: rgba(2,6,23,0.45); padding: 18px; }
    .modal.visible { display: grid; }
    .modal .sheet { width: min(900px, 96vw); max-height: 90vh; overflow: auto; }
    .field { display:grid; gap:6px; margin:10px 0; }
    .field label { font-size: 12px; color: var(--muted); }
    .field input, .field textarea, .field select { width:100%; padding:10px; border-radius:10px; border:1px solid var(--edge); }

    .tiny { font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Attachment Arcade</h1>
          <div class="sub">Spot the pattern ➜ pick a response ➜ unlock the secure upgrade.</div>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="presentBtn" title="Toggle Presenter Mode">Presenter</button>
        <button class="btn" id="shuffleBtn" title="Shuffle Scenarios">Shuffle</button>
        <button class="btn primary" id="drawBtn" title="Draw Next Scenario">Draw Scenario</button>
      </div>
    </header>

    <div class="controls">
      <div class="card pad">
        <div class="kicker">Facilitator Controls</div>
        <div class="toolbar" style="margin-top:8px">
          <button class="btn" id="resetBtn">Reset</button>
          <button class="btn" id="revealAllBtn">Reveal Style Map</button>
          <button class="btn" id="addCustomBtn">Add Custom Scenario</button>
          <button class="btn ghost" id="exportBtn">Export Notes</button>
        </div>
      </div>
      <div class="card pad timer">
        <div>
          <div class="kicker">Timer</div>
          <div class="toolbar" style="margin-top:6px">
            <select id="timerSelect" class="btn">
              <option value="30">30s</option>
              <option value="45">45s</option>
              <option value="60" selected>60s</option>
              <option value="90">90s</option>
              <option value="120">120s</option>
            </select>
            <button class="btn" id="startTimer">Start</button>
            <button class="btn" id="stopTimer">Stop</button>
            <button class="btn" id="resetTimer">Reset</button>
          </div>
        </div>
        <div>
          <div class="face" id="timerFace" data-running="false"><span id="timerText">60</span></div>
        </div>
      </div>
      <div class="card pad">
        <div class="kicker">How to Play</div>
        <p class="muted" style="margin-top:6px">Draw a scenario. Players choose a response. Reveal the <strong>style</strong> underneath and discuss the <em>secure upgrade</em>. Use the timer for quick rounds, or hit <strong>Reveal Style Map</strong> to compare all options at once.</p>
      </div>
    </div>

    <div class="grid">
      <section class="card pad scenario" aria-live="polite">
        <div class="pill"><span>Scenario</span> · <span id="counter">0 / 0</span></div>
        <div class="prompt" id="prompt">Click “Draw Scenario” to start.</div>
        <div class="options" id="options"></div>
        <div class="reveal" id="reveal"></div>
      </section>

      <aside class="side">
        <div class="card pad">
          <div class="kicker">Reflection</div>
          <div class="field">
            <label for="noteText">Add a quick note or takeaway</label>
            <textarea id="noteText" rows="3" placeholder="e.g., I default to pursue when anxious; secure upgrade = ask then self-soothe."></textarea>
            <div class="toolbar">
              <button class="btn" id="addNote">Add Note</button>
              <button class="btn ghost" id="clearNotes">Clear Notes</button>
            </div>
          </div>
          <div class="list" id="notesList" aria-live="polite"></div>
        </div>

        <div class="card pad">
          <div class="kicker">Legend</div>
          <div class="muted" style="display:grid; gap:6px; margin-top:8px">
            <div><span class="tag secure">Secure</span> Direct, boundaried, collaborative.</div>
            <div><span class="tag anx">Anxious</span> Pursues, protests, overfunctions.</div>
            <div><span class="tag avo">Avoidant</span> Withdraws, minimizes, underfunctions.</div>
            <div><span class="tag dis">Disorganized</span> Mixed signals, chaos, sarcasm/attack.</div>
          </div>
        </div>
      </aside>
    </div>

    <div class="footer">© Attachment Arcade · Built for in-room projection and laminated-card vibes.</div>
  </div>

  <!-- Custom Scenario Modal -->
  <div class="modal" id="modal">
    <div class="sheet card pad">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
        <strong>Add Custom Scenario</strong>
        <button class="btn" id="closeModal">Close</button>
      </div>
      <div class="field">
        <label>Scenario prompt</label>
        <textarea id="customPrompt" rows="2" placeholder="e.g., They go quiet for two days after a great weekend together."></textarea>
      </div>
      <div class="tiny">Add up to four options. Map each to a style. Secure option is recommended but not required.</div>
      <div id="customOptions"></div>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn" id="addOptionRow">Add Option</button>
        <button class="btn primary" id="saveScenario">Save Scenario</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Style metadata =====
    const STYLE_INFO = {
      secure: {
        key: 'secure', label: 'Secure / Direct', tagClass: 'secure', color: getComputedStyle(document.documentElement).getPropertyValue('--good').trim(),
        desc: 'Leans into honest communication, holds boundaries, aims to repair. Regulates first, then responds. Invites collaboration without chasing or withdrawing.',
        upgrade: 'Name the pattern, make a clear request, and allow space for the answer. Self-soothe while you wait.'
      },
      anxious: {
        key: 'anxious', label: 'Anxious / Pursuer', tagClass: 'anx', color: getComputedStyle(document.documentElement).getPropertyValue('--anx').trim(),
        desc: 'Moves toward quickly to reduce uncertainty (double-texting, overexplaining, people-pleasing). Attempts to control closeness when feeling unsafe.',
        upgrade: 'Pause, ground, and ask one clear question. Share impact briefly and resist over-functioning.'
      },
      avoidant: {
        key: 'avoidant', label: 'Avoidant / Withdrawn', tagClass: 'avo', color: getComputedStyle(document.documentElement).getPropertyValue('--avo').trim(),
        desc: 'Pulls back to manage overwhelm; minimizes needs and delays difficult talks. Creates distance to feel safe, which can escalate pursuer protest.',
        upgrade: 'Acknowledge the issue and set a time to revisit. Offer one honest sentence instead of going silent.'
      },
      disorganized: {
        key: 'disorganized', label: 'Disorganized / Chaotic', tagClass: 'dis', color: getComputedStyle(document.documentElement).getPropertyValue('--warn').trim(),
        desc: 'Sends mixed signals; flips between pursuit and withdrawal; may use sarcasm, jabs, or tests. Increases confusion and volatility.',
        upgrade: 'Slow down. Choose one lane: regulate, then share a clean, direct statement without tests or digs.'
      }
    };

    // ===== Scenario seed data =====
    /** Each scenario has: {prompt, options:[{text, style: 'secure|anxious|avoidant|disorganized'}]} */
    const SCENARIOS = [
      {
        prompt: 'Your partner leaves your message on read for 6 hours after a vulnerable text.',
        options: [
          { text: 'Send three rapid follow-ups and a “??” to force a reply.', style: 'anxious' },
          { text: 'Mute the thread and decide not to bring it up at all.', style: 'avoidant' },
          { text: 'Post a pointed meme on your story so they get the hint.', style: 'disorganized' },
          { text: 'Wait, self-soothe, then ask later: “Hey, can we check in about my text?”', style: 'secure' }
        ]
      },
      {
        prompt: 'They cancel last minute for the second time this month.',
        options: [
          { text: 'Say it’s fine, then keep hinting that you’re disappointed for days.', style: 'disorganized' },
          { text: 'Say nothing and mentally start detaching from the relationship.', style: 'avoidant' },
          { text: 'Call repeatedly now to make them feel how urgent this is.', style: 'anxious' },
          { text: 'Share impact + request: “I felt let down. Can we set firmer plans or reschedule now?”', style: 'secure' }
        ]
      },
      {
        prompt: 'A boundary you set (“no yelling”) is crossed during an argument.',
        options: [
          { text: 'Raise your volume to match theirs so you’re heard.', style: 'disorganized' },
          { text: 'Go silent and wait for it to blow over.', style: 'avoidant' },
          { text: 'Follow them to finish the talk now, even if they’ve tapped out.', style: 'anxious' },
          { text: 'Pause: “I’m stepping away. I’ll return in 20 minutes to talk if we can keep voices down.”', style: 'secure' }
        ]
      },
      {
        prompt: 'They joke about something you told them in confidence in front of friends.',
        options: [
          { text: 'Make a sharper joke back to even the score.', style: 'disorganized' },
          { text: 'Laugh it off and pretend it didn’t sting.', style: 'avoidant' },
          { text: 'Ask them right there why they’re trying to embarrass you.', style: 'anxious' },
          { text: 'Later: “That hurt. Please keep X private. Can we agree on that going forward?”', style: 'secure' }
        ]
      },
      {
        prompt: 'They pull away physically/sexually and you notice the distance.',
        options: [
          { text: 'Force intimacy so you can feel connected again.', style: 'anxious' },
          { text: 'Check out emotionally and stop initiating entirely.', style: 'avoidant' },
          { text: 'Flirt with someone else to get a reaction.', style: 'disorganized' },
          { text: 'Share gently: “I’m sensing some distance. Is anything up? I’m open to talk when you are.”', style: 'secure' }
        ]
      },
      {
        prompt: 'They respond to your boundary with: “You’re too sensitive.”',
        options: [
          { text: 'Prove you’re not by over-explaining every reason for hours.', style: 'anxious' },
          { text: 'Drop the boundary to keep the peace.', style: 'avoidant' },
          { text: 'Snap back with “At least I have feelings.”', style: 'disorganized' },
          { text: 'Restate once: “It matters to me. I won’t argue about my limit.”', style: 'secure' }
        ]
      },
      {
        prompt: 'You’re overwhelmed; they keep asking “What’s wrong?”',
        options: [
          { text: 'Say “Nothing” and disappear for the night.', style: 'avoidant' },
          { text: 'Dump everything in a 30-text monologue.', style: 'anxious' },
          { text: 'Say “You wouldn’t get it anyway.”', style: 'disorganized' },
          { text: '“Thanks for checking in. I need 30 minutes to decompress, then I can share.”', style: 'secure' }
        ]
      },
      {
        prompt: 'They start screen-peeking and questioning your phone habits.',
        options: [
          { text: 'Grab their phone and demand to see it too.', style: 'disorganized' },
          { text: 'Hide your phone more so it doesn’t come up.', style: 'avoidant' },
          { text: 'Over-share passcodes and receipts to calm them down.', style: 'anxious' },
          { text: 'Name the pattern + boundary: “I won’t be checked. If you’re anxious, let’s talk about trust.”', style: 'secure' }
        ]
      },
      {
        prompt: 'You disagree on weekend plans. They want solo time; you want together time.',
        options: [
          { text: 'Insist that time apart means they’re losing interest.', style: 'anxious' },
          { text: 'Say “whatever” and make separate plans to avoid conflict.', style: 'avoidant' },
          { text: 'Guilt-trip: “Guess I’ll just be lonely again.”', style: 'disorganized' },
          { text: 'Negotiate: one solo block + one together block. Put it on the calendar.', style: 'secure' }
        ]
      },
      {
        prompt: 'They take hours to reply during the workday even though they used to reply fast.',
        options: [
          { text: 'Assume avoidance and send a long “Where do we stand?” message.', style: 'anxious' },
          { text: 'Assume they don’t care and start mirroring with slow replies.', style: 'avoidant' },
          { text: 'Drop a cryptic story lyric so they’ll text you about it.', style: 'disorganized' },
          { text: 'Ask for clarity: “Should we set texting expectations for work hours?”', style: 'secure' }
        ]
      },
      {
        prompt: 'You bring up an issue; they change the subject.',
        options: [
          { text: 'Let it slide, then resent them later.', style: 'avoidant' },
          { text: 'Push harder now and talk over them to keep it on topic.', style: 'anxious' },
          { text: 'Make a sweeping accusation about their character.', style: 'disorganized' },
          { text: 'Hold the frame: “Let’s finish this first; we can circle back after.”', style: 'secure' }
        ]
      },
      {
        prompt: 'They complain that you “always need reassurance.”',
        options: [
          { text: 'Prove them wrong by going cold for a few days.', style: 'avoidant' },
          { text: 'Ask repeatedly if they still love you today.', style: 'anxious' },
          { text: 'Post something flirty to get compliments elsewhere.', style: 'disorganized' },
          { text: 'Own + ask: “I do seek reassurance when stressed. Can we set a ritual that helps both of us?”', style: 'secure' }
        ]
      },
      {
        prompt: 'They forget an important date to you.',
        options: [
          { text: 'Say it’s no big deal and swallow the disappointment.', style: 'avoidant' },
          { text: 'Make it a loyalty test and keep score.', style: 'disorganized' },
          { text: 'Rapid-fire reminders next time so it never happens again.', style: 'anxious' },
          { text: 'Share impact + request a do-over you plan together.', style: 'secure' }
        ]
      }
    ];

    // ===== State =====
    let deck = []; // shuffled copy
    let cursor = -1;

    const els = {
      prompt: document.getElementById('prompt'),
      options: document.getElementById('options'),
      reveal: document.getElementById('reveal'),
      counter: document.getElementById('counter'),
      drawBtn: document.getElementById('drawBtn'),
      shuffleBtn: document.getElementById('shuffleBtn'),
      resetBtn: document.getElementById('resetBtn'),
      revealAllBtn: document.getElementById('revealAllBtn'),
      presentBtn: document.getElementById('presentBtn'),
      addCustomBtn: document.getElementById('addCustomBtn'),
      exportBtn: document.getElementById('exportBtn'),
      // Notes
      noteText: document.getElementById('noteText'),
      addNote: document.getElementById('addNote'),
      clearNotes: document.getElementById('clearNotes'),
      notesList: document.getElementById('notesList'),
      // Timer
      timerSelect: document.getElementById('timerSelect'),
      startTimer: document.getElementById('startTimer'),
      stopTimer: document.getElementById('stopTimer'),
      resetTimer: document.getElementById('resetTimer'),
      timerFace: document.getElementById('timerFace'),
      timerText: document.getElementById('timerText'),
      // Modal
      modal: document.getElementById('modal'),
      closeModal: document.getElementById('closeModal'),
      customPrompt: document.getElementById('customPrompt'),
      customOptions: document.getElementById('customOptions'),
      addOptionRow: document.getElementById('addOptionRow'),
      saveScenario: document.getElementById('saveScenario'),
    };

    function shuffle(array){
      const a = array.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function setCounter(){ els.counter.textContent = `${Math.max(0,cursor+1)} / ${deck.length}`; }

    function drawScenario(){
      if(deck.length===0){ deck = shuffle(SCENARIOS); cursor = -1; }
      if(cursor < deck.length-1){ cursor++; }
      else { cursor = 0; }
      setCounter();
      renderScenario(deck[cursor]);
    }

    function renderScenario(s){
      els.prompt.textContent = s.prompt;
      els.options.innerHTML = '';
      els.reveal.classList.remove('visible');
      els.reveal.innerHTML = '';

      s.options.forEach((opt, idx)=>{
        const b = document.createElement('button');
        b.className = 'option';
        b.innerHTML = `<strong>Option ${String.fromCharCode(65+idx)}</strong>${opt.text}`;
        b.addEventListener('click', ()=> selectOption(s, opt));
        els.options.appendChild(b);
      });
    }

    function selectOption(s, opt){
      revealOne(opt);
    }

    function styleTag(style){
      const info = STYLE_INFO[style];
      return `<span class="tag ${info.tagClass}">${info.label}</span>`;
    }

    function revealOne(opt){
      const info = STYLE_INFO[opt.style];
      els.reveal.classList.add('visible');
      els.reveal.innerHTML = `
        <div style="display:grid; gap:10px">
          <div>${styleTag(opt.style)}</div>
          <p><strong>Why it fits:</strong> ${info.desc}</p>
          <p><strong>Secure upgrade:</strong> ${info.upgrade}</p>
        </div>
      `;
    }

    function revealAll(){
      const s = deck[cursor]; if(!s) return;
      els.reveal.classList.add('visible');
      const groups = s.options.map((opt, i)=>{
        const info = STYLE_INFO[opt.style];
        return `
          <div class="card pad" style="border-color:${info.color};">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px;">
              <div>${styleTag(opt.style)}</div>
              <div class="muted">Option ${String.fromCharCode(65+i)}</div>
            </div>
            <div style="font-weight:600; margin-bottom:6px">${opt.text}</div>
            <div class="tiny" style="margin-bottom:6px"><strong>Why it fits:</strong> ${info.desc}</div>
            <div class="tiny"><strong>Secure upgrade:</strong> ${info.upgrade}</div>
          </div>`
      }).join('');

      els.reveal.innerHTML = `<div style="display:grid; grid-template-columns:1fr; gap:10px;">${groups}</div>`;
    }

    // ===== Notes =====
    const notes = [];
    function drawNotes(){
      els.notesList.innerHTML = notes.map((n,i)=>`<div class="note">${i+1}. ${escapeHtml(n)}</div>`).join('');
    }
    function escapeHtml(str){ return str.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    function exportNotes(){
      const content = notes.map((n,i)=>`${i+1}. ${n}`).join('\n');
      const blob = new Blob([content], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'attachment-arcade-notes.txt'; a.click();
      URL.revokeObjectURL(url);
    }

    // ===== Timer =====
    let timerId = null; let remaining = parseInt(els.timerSelect.value, 10);
    function updateTimerFace(){ els.timerText.textContent = remaining; }
    function startTimer(){
      if(timerId) return;
      els.timerFace.dataset.running = 'true';
      timerId = setInterval(()=>{
        remaining--; updateTimerFace();
        if(remaining <= 0){ stopTimer(); beep(); }
      }, 1000);
    }
    function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } els.timerFace.dataset.running = 'false'; }
    function resetTimer(){ stopTimer(); remaining = parseInt(els.timerSelect.value, 10); updateTimerFace(); }
    function beep(){
      try {
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type='square'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
        o.start();
        g.gain.setValueAtTime(0.2, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.3);
        setTimeout(()=>{ o.stop(); ctx.close(); }, 350);
      } catch(e) { /* no audio */ }
    }

    // ===== Modal / Custom scenario builder =====
    function openModal(){ els.modal.classList.add('visible'); els.customOptions.innerHTML=''; addOptionRow(); addOptionRow(); }
    function closeModal(){ els.modal.classList.remove('visible'); }

    function addOptionRow(){
      const row = document.createElement('div');
      row.className='field';
      row.innerHTML = `
        <div style="display:grid; grid-template-columns: 1fr 160px auto; gap:8px; align-items:end;">
          <div>
            <label>Option text</label>
            <input type="text" class="co-text" placeholder="e.g., Ask to check in later with a time." />
          </div>
          <div>
            <label>Style</label>
            <select class="co-style">
              <option value="secure">Secure</option>
              <option value="anxious">Anxious</option>
              <option value="avoidant">Avoidant</option>
              <option value="disorganized">Disorganized</option>
            </select>
          </div>
          <div>
            <button class="btn ghost co-remove">Remove</button>
          </div>
        </div>`;
      row.querySelector('.co-remove').addEventListener('click', ()=> row.remove());
      els.customOptions.appendChild(row);
    }

    function saveCustomScenario(){
      const prompt = els.customPrompt.value.trim();
      const rows = Array.from(els.customOptions.querySelectorAll('.field'));
      const opts = rows.map(r=>({ text: r.querySelector('.co-text').value.trim(), style: r.querySelector('.co-style').value } )).filter(o=>o.text);
      if(!prompt || opts.length===0){ alert('Add a prompt and at least one option.'); return; }
      SCENARIOS.push({ prompt, options: opts });
      deck = shuffle(SCENARIOS);
      cursor = -1; setCounter();
      closeModal();
      els.customPrompt.value='';
    }

    // ===== Events =====
    els.drawBtn.addEventListener('click', drawScenario);
    els.shuffleBtn.addEventListener('click', ()=>{ deck = shuffle(SCENARIOS); cursor=-1; setCounter(); drawScenario(); });
    els.resetBtn.addEventListener('click', ()=>{ cursor=-1; setCounter(); els.prompt.textContent='Click “Draw Scenario” to start.'; els.options.innerHTML=''; els.reveal.classList.remove('visible'); els.reveal.innerHTML=''; });
    els.revealAllBtn.addEventListener('click', revealAll);

    els.presentBtn.addEventListener('click', ()=>{ document.documentElement.classList.toggle('present'); });

    // Notes
    els.addNote.addEventListener('click', ()=>{ const t=els.noteText.value.trim(); if(!t) return; notes.push(t); els.noteText.value=''; drawNotes(); });
    els.clearNotes.addEventListener('click', ()=>{ if(confirm('Clear all notes?')){ notes.length=0; drawNotes(); }});
    els.exportBtn.addEventListener('click', exportNotes);

    // Timer
    els.timerSelect.addEventListener('change', ()=>{ remaining = parseInt(els.timerSelect.value,10); updateTimerFace(); });
    els.startTimer.addEventListener('click', startTimer);
    els.stopTimer.addEventListener('click', stopTimer);
    els.resetTimer.addEventListener('click', resetTimer);

    // Modal
    document.getElementById('addCustomBtn').addEventListener('click', openModal);
    els.closeModal.addEventListener('click', closeModal);
    els.addOptionRow.addEventListener('click', addOptionRow);
    els.saveScenario.addEventListener('click', saveCustomScenario);
    els.modal.addEventListener('click', (e)=>{ if(e.target===els.modal) closeModal(); });

    // Init
    deck = shuffle(SCENARIOS);
    setCounter();
    resetTimer();
  </script>
</body>
</html>
